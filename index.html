<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
  <title>Gesti√≥n de Ventas</title>
   
  <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
  <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
  <link rel="manifest" href="./manifest.webmanifest">

  <style>
    /* --- ESTILOS PERSONALIZADOS --- */

    /* 1. Fechas */
    .fecha-destacada {
        font-size: 1.05rem !important;
        font-weight: 600 !important;
        color: #1e293b !important;
    }
    
    /* 2. Top Clientes */
    .top-client-name {
        font-size: 1rem !important; 
        font-weight: 700 !important;
        color: #0f172a !important;
        display: block;
        line-height: 1.2;
        margin-bottom: 2px;
    }

    .importe-top-ajustado {
        font-size: 0.9rem !important;
        font-weight: 700 !important;
        color: #2563eb !important;
        display: block;
    }

    /* 3. Comunidades */
    .community-price-moved {
        font-size: 1.2rem !important;
        font-weight: 700 !important;
        color: #2563eb !important;
        margin-top: 4px !important;
        margin-bottom: 4px !important;
        display: block !important;
    }

    .contador-extra {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
        color: #475569;
        font-weight: 600;
        margin-top: 2px;
        background-color: #f1f5f9;
        padding: 4px 10px;
        border-radius: 6px;
        width: fit-content;
    }

    /* 4. Men√∫ Inferior (Reset) */
    .nav-item-normalized {
        background-color: transparent !important;
        background: transparent !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        transform: none !important;
        padding: 6px 0 !important;
        margin: 0 !important;
        height: auto !important;
        width: 100% !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
    }
    .nav-item-normalized * { color: #64748b !important; }
    .nav-item-active * { color: #2563eb !important; }
    
    /* 5. Estilo Bot√≥n Anual Forzado */
    .fixed-anual {
        color: #3b82f6 !important;
        font-weight: 700 !important;
        text-transform: uppercase !important;
        cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // ------------------------------------------------
    // 1. L√ìGICA DE CONTEO
    // ------------------------------------------------
    function contarPedidosPorZona() {
        const contadores = { 'ASTURIAS': 0, 'CANTABRIA': 0, 'LEON': 0, 'GALICIA': 0 };
        try {
            const db = JSON.parse(localStorage.getItem('ventas-storage'));
            if (!db) return contadores; 
            const anio = localStorage.getItem('selectedYear') || new Date().getFullYear().toString();
            const mapa = {};
            if(db.clients) db.clients.forEach(c => { if(c.name && c.province) mapa[c.name.trim()] = c.province.toUpperCase().trim(); });
            if(db.orders) db.orders.forEach(p => {
                if (p.date && p.date.startsWith(anio)) {
                    const prov = mapa[p.clientName.trim()];
                    if (prov) {
                        if (prov === 'ASTURIAS') contadores['ASTURIAS']++;
                        else if (prov === 'CANTABRIA') contadores['CANTABRIA']++;
                        else if (prov === 'LEON') contadores['LEON']++;
                        else if (['LUGO', 'ORENSE', 'PONTEVEDRA', 'CORU√ëA', 'A CORU√ëA'].includes(prov)) contadores['GALICIA']++;
                    }
                }
            });
            return contadores;
        } catch (e) { return contadores; }
    }

    // ------------------------------------------------
    // 2. EL VIGILANTE DE CAMBIOS (DOM)
    // ------------------------------------------------
    const observer = new MutationObserver(() => {
       
      // --- A. TEXTOS GENERALES ---
      document.querySelectorAll('button, div, span, h1, h2, h3, p, a').forEach(el => {
          if (el.children.length === 0 && el.textContent) { 
              const texto = el.textContent.trim();
              const textoUpper = texto.toUpperCase();
              
              // 1. REEMPLAZO HIST√ìRICO -> ANUAL
              if (textoUpper === "HIST√ìRICO" || textoUpper === "HISTORICO") {
                  el.textContent = "ANUAL";
                  el.classList.add('fixed-anual');
              }

              // 2. REEMPLAZO MEDIA MENSUAL -> VENTA MEDIA ANUAL (NUEVO)
              if (textoUpper === "MEDIA MENSUAL GLOBAL" || texto === "Media mensual global") {
                  el.textContent = "VENTA MEDIA ANUAL";
              }

              // 3. Otros ajustes menores
              if (texto === "Hist√≥rico Ventas") el.textContent = "Ventas medias mensuales";
              
              // 4. Correcci√≥n de "Anual" suelto
              if (texto === "Anual" && !el.closest('button') && !el.classList.contains('fixed-anual')) {
                  el.textContent = "Ventas";
              }
          }
      });

      // --- B. FECHAS ---
      const regexFecha = /^(\d{4})-(\d{2})-(\d{2})$/;
      document.querySelectorAll('td, div, span, p').forEach(el => {
          const texto = el.textContent.trim();
          if (regexFecha.test(texto)) {
              el.textContent = texto.replace(regexFecha, '$3-$2-$1');
              el.classList.add('fecha-destacada');
          }
      });

      // --- C. DASHBOARD: TOP CLIENTES ---
      const seccionTop = Array.from(document.querySelectorAll('h2, h3, div')).find(el => el.textContent.includes("Top Clientes"));
      if (seccionTop) {
          const contenedorPadre = seccionTop.closest('div').parentElement;
          if (contenedorPadre) {
              const filas = contenedorPadre.querySelectorAll('div'); 
              filas.forEach(fila => {
                  const textos = fila.querySelectorAll('span, div, p');
                  let precioEl = null;
                  let nombreEl = null;
                  textos.forEach(t => {
                      if (t.textContent.includes('‚Ç¨')) precioEl = t;
                      else if (t.textContent.length > 2 && !t.querySelector('*')) nombreEl = t; 
                  });
                  if (precioEl && nombreEl) {
                      if (!precioEl.classList.contains('importe-top-ajustado')) precioEl.classList.add('importe-top-ajustado');
                      if (!nombreEl.classList.contains('top-client-name')) nombreEl.classList.add('top-client-name');
                  }
              });
          }
      }

      // --- D. DASHBOARD: COMUNIDADES ---
      const datos = contarPedidosPorZona();
      if (datos) {
          const zonas = ['ASTURIAS', 'CANTABRIA', 'LEON', 'LE√ìN', 'GALICIA'];
          document.querySelectorAll('h3, span, div, p').forEach(el => {
             const texto = el.textContent.trim().toUpperCase();
             if (!zonas.includes(texto)) return;

             const key = (texto === 'LE√ìN') ? 'LEON' : texto;
             const cantidad = datos[key];
             const card = el.closest('div.bg-white') || el.closest('div.shadow-sm') || el.parentElement.parentElement;
             
             if (card) {
                 const precio = Array.from(card.querySelectorAll('div, span')).find(x => x.textContent.includes('‚Ç¨'));
                 if (precio) {
                     if (el.nextElementSibling !== precio && !precio.classList.contains('community-price-moved')) {
                         el.after(precio);
                         precio.classList.add('community-price-moved');
                     }
                     if (!card.querySelector('.contador-extra')) {
                         const nuevoDiv = document.createElement('div');
                         nuevoDiv.className = 'contador-extra';
                         nuevoDiv.innerHTML = `üì¶ ${cantidad} Pedidos`;
                         precio.after(nuevoDiv);
                     }
                 }
             }
          });
      }

      // --- E. CORRECCI√ìN MEN√ö INFERIOR ---
      const menuLabels = ["Totales", "Factura"];
      menuLabels.forEach(label => {
          document.querySelectorAll('span, div, p, a').forEach(el => {
              if (el.textContent.trim() === label) {
                  const parent = el.closest('a') || el.closest('div[role="button"]') || el.parentElement;
                  if (parent) {
                      parent.classList.add('nav-item-normalized');
                      const style = window.getComputedStyle(parent);
                      const isBlueBg = style.backgroundColor.includes('235') || style.backgroundColor.includes('37');
                      if (isBlueBg || parent.classList.toString().includes('active') || parent.classList.toString().includes('selected')) {
                          parent.classList.add('nav-item-active');
                      }
                  }
              }
          });
      });

    });

    observer.observe(document.body, { childList: true, subtree: true });
  </script>
</body>
</html>
