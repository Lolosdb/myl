<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
  <title>Gesti√≥n de Ventas</title>
   
  <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
  <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
  <link rel="manifest" href="./manifest.webmanifest">

  <style>
    /* --- ESTILOS PERSONALIZADOS --- */

    /* 1. Estilos Globales */
    body { -webkit-tap-highlight-color: transparent; }

    /* 2. Fechas */
    .fecha-destacada {
        font-size: 1.05rem !important;
        font-weight: 600 !important;
        color: #1e293b !important;
    }
    
    /* 3. Top Clientes */
    .top-client-name {
        font-size: 1rem !important; 
        font-weight: 700 !important;
        color: #0f172a !important;
        display: block;
        line-height: 1.2;
        margin-bottom: 2px;
    }

    .importe-top-ajustado {
        font-size: 0.9rem !important;
        font-weight: 700 !important;
        color: #2563eb !important;
        display: block;
    }

    /* 4. Comunidades (Estilos Cr√≠ticos) */
    .community-price-moved {
        font-size: 1.2rem !important;
        font-weight: 700 !important;
        color: #2563eb !important;
        margin-top: 4px !important;
        margin-bottom: 4px !important;
        display: block !important;
    }

    .contador-extra {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem; /* Un poco m√°s grande para que se vea bien */
        color: #334155;
        font-weight: 700;
        margin-top: 4px;
        background-color: #f1f5f9;
        padding: 4px 12px;
        border-radius: 8px;
        width: fit-content;
        border: 1px solid #e2e8f0;
    }

    /* 5. ARREGLO MEN√ö INFERIOR (BLANQUEAMIENTO FORZOSO) */
    .nav-item-forced {
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
        opacity: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
    }

    /* Truco para volver blancos los iconos oscuros/grises */
    .nav-item-forced svg, 
    .nav-item-forced img,
    .nav-item-forced i {
        color: #ffffff !important;
        fill: #ffffff !important;
        stroke: #ffffff !important;
        filter: brightness(0) invert(1) !important; /* Vuelve blanco cualquier cosa oscura */
    }
    
    .nav-item-forced span, 
    .nav-item-forced p, 
    .nav-item-forced div {
        color: #ffffff !important;
        font-weight: 500 !important;
    }

    /* 6. Textos especiales */
    .fixed-anual {
        color: #3b82f6 !important;
        font-weight: 700 !important;
        text-transform: uppercase !important;
        cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // ------------------------------------------------
    // 1. L√ìGICA DE CONTEO (Backend local)
    // ------------------------------------------------
    function contarPedidosPorZona() {
        // Valores por defecto (asegura que siempre devuelva objeto)
        const contadores = { 'ASTURIAS': 0, 'CANTABRIA': 0, 'LEON': 0, 'GALICIA': 0 };
        try {
            const rawDb = localStorage.getItem('ventas-storage');
            if (!rawDb) return contadores; // Si no hay DB, devuelve ceros
            
            const db = JSON.parse(rawDb);
            const anio = localStorage.getItem('selectedYear') || new Date().getFullYear().toString();
            const mapa = {};
            
            // Mapear clientes a provincias
            if(db.clients) {
                db.clients.forEach(c => { 
                    if(c.name && c.province) mapa[c.name.trim()] = c.province.toUpperCase().trim(); 
                });
            }

            // Contar pedidos
            if(db.orders) {
                db.orders.forEach(p => {
                    // Verificaci√≥n de fecha robusta
                    if (p.date && String(p.date).startsWith(anio)) {
                        const clientClean = p.clientName ? p.clientName.trim() : '';
                        const prov = mapa[clientClean];
                        if (prov) {
                            if (prov === 'ASTURIAS') contadores['ASTURIAS']++;
                            else if (prov === 'CANTABRIA') contadores['CANTABRIA']++;
                            else if (prov === 'LEON' || prov === 'LE√ìN') contadores['LEON']++;
                            else if (['LUGO', 'ORENSE', 'PONTEVEDRA', 'CORU√ëA', 'A CORU√ëA'].includes(prov)) contadores['GALICIA']++;
                        }
                    }
                });
            }
            return contadores;
        } catch (e) { console.error(e); return contadores; }
    }

    // ------------------------------------------------
    // 2. EL VIGILANTE (DOM)
    // ------------------------------------------------
    const observer = new MutationObserver(() => {
       
      // --- A. CORRECCIONES DE TEXTO ---
      const replacements = {
          "HIST√ìRICO": "ANUAL",
          "HISTORICO": "ANUAL",
          "Hist√≥rico Ventas": "Ventas medias mensuales",
          "Media mensual global": "VENTA MEDIA ANUAL",
          "MEDIA MENSUAL GLOBAL": "VENTA MEDIA ANUAL"
      };

      document.querySelectorAll('*').forEach(el => {
          // Solo nodos de texto directo
          if (el.children.length === 0 && el.textContent.trim().length > 0) {
              const txt = el.textContent.trim();
              const txtUpper = txt.toUpperCase();

              // Aplicar diccionario de reemplazos
              for (const [key, val] of Object.entries(replacements)) {
                  if (txt === key || txtUpper === key) {
                      el.textContent = val;
                      if (val === "ANUAL") el.classList.add('fixed-anual');
                  }
              }

              // Correcci√≥n espec√≠fica 'Anual' suelto
              if (txt === "Anual" && !el.closest('button') && !el.classList.contains('fixed-anual')) {
                  el.textContent = "Ventas";
              }
          }
      });

      // --- B. FORMATO DE FECHAS (YYYY-MM-DD -> DD-MM-YYYY) ---
      const regexFecha = /^(\d{4})-(\d{2})-(\d{2})$/;
      document.querySelectorAll('td, div, span, p').forEach(el => {
          if (regexFecha.test(el.textContent.trim())) {
              el.textContent = el.textContent.trim().replace(regexFecha, '$3-$2-$1');
              el.classList.add('fecha-destacada');
          }
      });

      // --- C. TOP CLIENTES (Estilos) ---
      const topHeader = Array.from(document.querySelectorAll('h2, h3, div')).find(e => e.textContent.includes("Top Clientes"));
      if (topHeader) {
          const container = topHeader.closest('div').parentElement;
          if (container) {
              container.querySelectorAll('div').forEach(row => {
                  const items = row.querySelectorAll('span, div, p');
                  let price = null, name = null;
                  items.forEach(i => {
                      if (i.textContent.includes('‚Ç¨')) price = i;
                      else if (i.textContent.length > 2) name = i;
                  });
                  
                  if (price && name) {
                      price.classList.add('importe-top-ajustado');
                      name.classList.add('top-client-name');
                  }
              });
          }
      }

      // --- D. COMUNIDADES (L√≥gica Reforzada) ---
      const datos = contarPedidosPorZona();
      const zonasObjetivo = ['ASTURIAS', 'CANTABRIA', 'LEON', 'LE√ìN', 'GALICIA'];
      
      // Buscar elementos que contengan exactamente el nombre de la zona
      document.querySelectorAll('h3, span, div, p, h4').forEach(el => {
          const texto = el.textContent.trim().toUpperCase();
          
          if (zonasObjetivo.includes(texto)) {
              // Normalizar clave
              const key = (texto === 'LE√ìN') ? 'LEON' : texto;
              const cantidad = datos[key];

              // Encontrar el contenedor "Tarjeta" subiendo en el √°rbol DOM
              // Buscamos un padre que contenga tambi√©n el precio
              let parent = el.parentElement;
              let foundPrice = null;
              let attempts = 0;

              // Subimos hasta 3 niveles buscando el precio hermano
              while (parent && attempts < 4) {
                  const possiblePrice = Array.from(parent.querySelectorAll('*')).find(x => x.textContent.includes('‚Ç¨') && x !== parent);
                  if (possiblePrice) {
                      foundPrice = possiblePrice;
                      break; // ¬°Precio encontrado!
                  }
                  parent = parent.parentElement;
                  attempts++;
              }

              if (foundPrice) {
                  // 1. Mover precio debajo del t√≠tulo (si no est√° ya)
                  if (el.nextElementSibling !== foundPrice && !foundPrice.classList.contains('community-price-moved')) {
                      el.after(foundPrice);
                      foundPrice.classList.add('community-price-moved');
                  }

                  // 2. Insertar Contador (si no existe)
                  // Buscamos si ya existe el contador en este 'parent'
                  let contador = parent.querySelector('.contador-extra');
                  
                  // Si no existe, lo creamos
                  if (!contador) {
                      contador = document.createElement('div');
                      contador.className = 'contador-extra';
                      // Insertamos justo despu√©s del precio
                      foundPrice.after(contador);
                  }

                  // Actualizamos el texto siempre (por si cambia de 0 a 1)
                  if (contador.textContent !== `üì¶ ${cantidad} Pedidos`) {
                      contador.innerHTML = `üì¶ ${cantidad} Pedidos`;
                  }
              }
          }
      });

      // --- E. MEN√ö INFERIOR (Limpieza Total) ---
      const menuItems = ["Totales", "Factura", "Dash", "Pedidos", "Clientes", "Alertas", "Objetivos", "Mapa"];
      menuItems.forEach(label => {
          document.querySelectorAll('span, div, p, a').forEach(el => {
              if (el.textContent.trim() === label) {
                  // Subir hasta encontrar el elemento interactivo
                  const btn = el.closest('a') || el.closest('[role="button"]') || el.parentElement;
                  if (btn) {
                      btn.classList.add('nav-item-forced');
                      // Si el bot√≥n est√° "activo" (tiene clase active o fondo azul), le ponemos borde inferior
                      const style = window.getComputedStyle(btn);
                      if (style.backgroundColor.includes('23') || style.backgroundColor.includes('37') || btn.className.includes('active')) {
                          btn.style.borderBottom = "3px solid white";
                          btn.style.paddingBottom = "5px";
                      }
                  }
              }
          });
      });

    });

    // Observar todo el cuerpo con configuraci√≥n m√°xima
    observer.observe(document.body, { childList: true, subtree: true, attributes: true });
  </script>
</body>
</html>
