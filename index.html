<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
  <title>Gesti√≥n de Ventas</title>
   
  <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
  <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
  <link rel="manifest" href="./manifest.webmanifest">

  <style>
    /* =========================================
       ESTILOS DE CORRECCI√ìN (SEGUROS)
       ========================================= */

    /* 1. ESTILOS GENERALES (Sin romper la app) */
    body {
        /* Aseguramos color de texto base oscuro */
        color: #1e293b;
    }

    /* 2. TEXTOS Y FECHAS */
    .fecha-destacada {
        font-size: 1.05rem !important;
        font-weight: 600 !important;
        color: #1e293b !important;
    }
    .texto-anual-fixed {
        text-transform: uppercase !important;
        font-weight: 700 !important;
        color: #3b82f6 !important; /* Azul bot√≥n */
    }

    /* 3. TOP CLIENTES */
    .top-client-name {
        font-size: 1rem !important; 
        font-weight: 700 !important;
        color: #0f172a !important;
        display: block;
        line-height: 1.2;
        margin-bottom: 2px;
    }
    .importe-top-ajustado {
        font-size: 0.9rem !important;
        font-weight: 700 !important;
        color: #2563eb !important;
        display: block;
    }

    /* 4. COMUNIDADES (Pedidos y Precios) */
    .community-price-moved {
        font-size: 1.2rem !important;
        font-weight: 700 !important;
        color: #2563eb !important;
        margin-top: 4px !important;
        margin-bottom: 4px !important;
        display: block !important;
    }
    .contador-extra {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem; /* Tama√±o legible */
        color: #334155;     /* Gris oscuro, no blanco */
        font-weight: 600;
        margin-top: 4px;
        background-color: #f1f5f9; /* Fondo gris claro */
        padding: 4px 10px;
        border-radius: 6px;
        width: fit-content;
        border: 1px solid #e2e8f0;
    }

    /* 5. MEN√ö INFERIOR (Arreglo Espec√≠fico) */
    
    /* Clase para la barra contenedora */
    .footer-bar-fixed {
        background-color: #2563eb !important; /* Azul fuerte consistente */
    }

    /* Clase para los botones individuales */
    .footer-btn-fixed {
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
        border-radius: 0 !important;
        opacity: 1 !important;
        padding-top: 6px !important;
        padding-bottom: 6px !important;
    }

    /* Forzar color BLANCO solo dentro del footer */
    .footer-btn-fixed span,
    .footer-btn-fixed p,
    .footer-btn-fixed div {
        color: #ffffff !important;
    }

    /* Iconos SVG en blanco */
    .footer-btn-fixed svg,
    .footer-btn-fixed img {
        filter: brightness(0) invert(1) !important;
    }

    /* CORRECCI√ìN ESPEC√çFICA PARA EL S√çMBOLO ‚Ç¨ (Totales) */
    .icon-euro-fixed {
        color: #ffffff !important;
        font-size: 26px !important; /* Aumentamos tama√±o para igualar iconos */
        font-weight: 400 !important;
        font-style: normal !important;
        line-height: 1 !important;
        display: block !important;
        margin-bottom: 4px !important;
    }

    /* Indicador activo */
    .footer-active {
        border-bottom: 3px solid white !important;
    }

  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // -----------------------------------------------------------
    // 1. L√ìGICA DE DATOS (Contar pedidos - Relajada)
    // -----------------------------------------------------------
    function getContadores() {
        const resultado = { 'ASTURIAS': 0, 'CANTABRIA': 0, 'LEON': 0, 'GALICIA': 0 };
        try {
            const raw = localStorage.getItem('ventas-storage');
            if (!raw) return resultado;
            const db = JSON.parse(raw);
            if (!db.orders || !Array.isArray(db.orders)) return resultado;

            const anio = localStorage.getItem('selectedYear') || new Date().getFullYear().toString();
            
            // Mapa Cliente -> Provincia (Normalizando texto)
            const mapa = {};
            if(db.clients) db.clients.forEach(c => { 
                if(c.name && c.province) {
                    mapa[c.name.trim().toUpperCase()] = c.province.trim().toUpperCase(); 
                }
            });

            db.orders.forEach(o => {
                if (o.date && String(o.date).startsWith(anio)) {
                    const clienteNombre = o.clientName ? o.clientName.trim().toUpperCase() : '';
                    const prov = mapa[clienteNombre];
                    
                    if (prov) {
                        if (prov.includes('ASTURIAS')) resultado['ASTURIAS']++;
                        else if (prov.includes('CANTABRIA')) resultado['CANTABRIA']++;
                        else if (prov.includes('LEON') || prov.includes('LE√ìN')) resultado['LEON']++;
                        else if (['LUGO', 'ORENSE', 'PONTEVEDRA', 'CORU√ëA', 'A CORU√ëA'].some(x => prov.includes(x))) resultado['GALICIA']++;
                    }
                }
            });
        } catch(e) { console.log(e); }
        return resultado;
    }

    // -----------------------------------------------------------
    // 2. BUCLE DE CONTROL (Cada 300ms)
    // -----------------------------------------------------------
    setInterval(() => {
        
        // --- A. ARREGLO DEL MEN√ö INFERIOR ---
        const menuLabels = ["Totales", "Factura", "Dash", "Pedidos", "Clientes", "Alertas", "Objetivos", "Mapa"];
        
        // Buscar la barra contenedora
        const dashLabel = Array.from(document.querySelectorAll('span, p, div')).find(el => el.textContent.trim() === 'Dash');
        if (dashLabel) {
             const btn = dashLabel.closest('a') || dashLabel.closest('[role="button"]') || dashLabel.parentElement;
             if (btn && btn.parentElement) {
                 const footerBar = btn.parentElement;
                 if (!footerBar.classList.contains('footer-bar-fixed')) {
                     footerBar.classList.add('footer-bar-fixed');
                 }

                 // Recorrer hijos (botones)
                 Array.from(footerBar.children).forEach(child => {
                     if (!child.classList.contains('footer-btn-fixed')) {
                         child.classList.add('footer-btn-fixed');
                     }

                     // Marcar activo
                     const style = window.getComputedStyle(child);
                     if (style.backgroundColor.includes('23') || style.backgroundColor.includes('37') || child.className.includes('active')) {
                         child.classList.add('footer-active');
                     } else {
                         child.classList.remove('footer-active');
                     }

                     // CASO ESPECIAL: BOT√ìN TOTALES (‚Ç¨)
                     // Buscamos si este bot√≥n tiene el texto "Totales"
                     if (child.textContent.includes("Totales")) {
                         // Buscamos el elemento que hace de icono (el s√≠mbolo ‚Ç¨)
                         // Suele ser un div, span o i que NO contiene el texto "Totales"
                         const iconCandidates = child.querySelectorAll('div, span, i');
                         iconCandidates.forEach(icon => {
                             const txt = icon.textContent.trim();
                             if (txt === '‚Ç¨' || txt.includes('‚Ç¨')) {
                                 icon.classList.add('icon-euro-fixed');
                             }
                         });
                     }
                 });
             }
        }

        // --- B. TEXTOS (Hist√≥rico -> Anual) ---
        document.querySelectorAll('*').forEach(el => {
            // Solo nodos hoja
            if(el.children.length === 0 && el.textContent.trim().length > 0) {
                const txt = el.textContent.trim();
                const txtUpper = txt.toUpperCase();

                if (txtUpper === "HIST√ìRICO" || txtUpper === "HISTORICO") {
                    if (el.textContent !== "ANUAL") {
                        el.textContent = "ANUAL";
                        el.classList.add('texto-anual-fixed');
                    }
                }
                if (txtUpper === "MEDIA MENSUAL GLOBAL" || txt === "Media mensual global") {
                    if (el.textContent !== "VENTA MEDIA ANUAL") {
                        el.textContent = "VENTA MEDIA ANUAL";
                    }
                }
                if (txt === "Anual" && !el.closest('button') && !el.classList.contains('texto-anual-fixed')) {
                    el.textContent = "Ventas";
                }
            }
        });

        // --- C. FECHAS ---
        document.querySelectorAll('td, div, span, p').forEach(el => {
            const txt = el.textContent.trim();
            if (/^\d{4}-\d{2}-\d{2}$/.test(txt)) {
                const [y, m, d] = txt.split('-');
                el.textContent = `${d}-${m}-${y}`;
                el.classList.add('fecha-destacada');
            }
        });

        // --- D. TOP CLIENTES ---
        const headerTop = Array.from(document.querySelectorAll('h2, h3, div')).find(x => x.textContent.includes("Top Clientes"));
        if(headerTop) {
            const card = headerTop.closest('div').parentElement; 
            if(card) {
                card.querySelectorAll('div').forEach(row => {
                   const hijos = row.querySelectorAll('span, div, p');
                   let precio = null, nombre = null;
                   hijos.forEach(h => {
                       if(h.textContent.includes('‚Ç¨')) precio = h;
                       else if(h.textContent.length > 2) nombre = h;
                   });
                   if(precio && nombre) {
                       if(!precio.classList.contains('importe-top-ajustado')) precio.classList.add('importe-top-ajustado');
                       if(!nombre.classList.contains('top-client-name')) nombre.classList.add('top-client-name');
                   }
                });
            }
        }

        // --- E. PEDIDOS EN COMUNIDADES (Inserci√≥n Segura) ---
        const datos = getContadores();
        const zonas = ['ASTURIAS', 'CANTABRIA', 'LEON', 'LE√ìN', 'GALICIA'];
        
        document.querySelectorAll('h3, span, div, p').forEach(el => {
            const zonaTxt = el.textContent.trim().toUpperCase();
            if(zonas.includes(zonaTxt)) {
                
                const keyData = (zonaTxt === 'LE√ìN') ? 'LEON' : zonaTxt;
                const numPedidos = datos[keyData]; // Ser√° 0 si no hay datos, pero no null

                // Buscar precio hermano o cercano
                let candidato = el.parentElement;
                let precioEncontrado = null;
                // Subimos 4 niveles max
                for(let i=0; i<4; i++) {
                    if(!candidato) break;
                    const precio = Array.from(candidato.querySelectorAll('*')).find(x => x.textContent.includes('‚Ç¨') && x !== candidato);
                    if(precio) {
                        precioEncontrado = precio;
                        break;
                    }
                    candidato = candidato.parentElement;
                }

                if(precioEncontrado) {
                    // Mover el precio debajo del t√≠tulo
                    if(el.nextElementSibling !== precioEncontrado && !precioEncontrado.classList.contains('community-price-moved')) {
                        el.after(precioEncontrado);
                        precioEncontrado.classList.add('community-price-moved');
                    }

                    // Insertar contador
                    let contador = null;
                    let hermano = precioEncontrado.nextElementSibling;
                    if(hermano && hermano.classList.contains('contador-extra')) contador = hermano;

                    if(!contador) {
                        contador = document.createElement('div');
                        contador.className = 'contador-extra';
                        precioEncontrado.after(contador);
                    }
                    // Actualizamos texto siempre
                    if(contador.textContent !== `üì¶ ${numPedidos} Pedidos`) {
                        contador.textContent = `üì¶ ${numPedidos} Pedidos`;
                    }
                }
            }
        });

    }, 300);
  </script>
</body>
</html>
