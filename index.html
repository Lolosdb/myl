<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
  <title>Gesti√≥n de Ventas</title>
   
  <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
  <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
  <link rel="manifest" href="./manifest.webmanifest">

  <style>
    /* --- CORRECCIONES QUIR√öRGICAS (Sin romper el resto) --- */

    /* 1. FECHAS (Formato limpio) */
    .fecha-destacada {
        font-size: 1.05rem !important;
        font-weight: 600 !important;
        color: #1e293b !important;
    }
    
    /* 2. TEXTOS FIJOS */
    .texto-anual-fixed {
        text-transform: uppercase !important;
        font-weight: 700 !important;
        color: #3b82f6 !important; /* Azul original del bot√≥n */
    }

    /* 3. TOP CLIENTES */
    .top-client-name {
        font-size: 1rem !important; 
        font-weight: 700 !important;
        color: #0f172a !important;
        display: block;
        line-height: 1.2;
        margin-bottom: 2px;
    }
    .importe-top-ajustado {
        font-size: 0.9rem !important;
        font-weight: 700 !important;
        color: #2563eb !important;
        display: block;
    }

    /* 4. PEDIDOS EN COMUNIDADES */
    .contador-extra-simple {
        display: block;
        width: 100%;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px dashed #e2e8f0;
        font-size: 0.9rem;
        color: #475569;
        font-weight: 700;
    }

    /* 5. ARREGLO MEN√ö (Espec√≠fico para Totales y Factura) */
    .menu-btn-clean {
        background: transparent !important;
        background-color: transparent !important;
        box-shadow: none !important;
        border: none !important;
        border-radius: 0 !important;
    }
    
    /* Forzar que el contenido sea blanco (solo dentro del bot√≥n limpiado) */
    .menu-btn-clean * {
        color: #ffffff !important;
        fill: #ffffff !important;
    }
    
    /* Filtro para iconos SVG oscuros */
    .menu-btn-clean svg, .menu-btn-clean img {
        filter: brightness(0) invert(1) !important;
    }

    /* EL ARREGLO DEL EURO: Hacemos el s√≠mbolo m√°s grande */
    .euro-icon-big {
        font-size: 26px !important; /* Aumentado para igualar iconos */
        line-height: 1 !important;
        display: inline-block !important;
        font-weight: 400 !important;
        font-family: sans-serif !important;
    }
    
    /* Indicador de activo */
    .menu-active-border {
        border-bottom: 3px solid white !important;
        padding-bottom: 4px !important;
    }

  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // -----------------------------------------------------------
    // L√ìGICA DE DATOS
    // -----------------------------------------------------------
    function getContadores() {
        const resultado = { 'ASTURIAS': 0, 'CANTABRIA': 0, 'LEON': 0, 'GALICIA': 0 };
        try {
            const raw = localStorage.getItem('ventas-storage');
            if (!raw) return resultado;
            const db = JSON.parse(raw);
            if (!db.orders || !Array.isArray(db.orders)) return resultado;

            const anio = localStorage.getItem('selectedYear') || new Date().getFullYear().toString();
            const mapa = {};
            if(db.clients) db.clients.forEach(c => { 
                if(c.name && c.province) mapa[c.name.trim().toUpperCase()] = c.province.trim().toUpperCase(); 
            });

            db.orders.forEach(o => {
                if (o.date && String(o.date).startsWith(anio)) {
                    const cli = o.clientName ? o.clientName.trim().toUpperCase() : '';
                    const prov = mapa[cli];
                    if (prov) {
                        if (prov.includes('ASTURIAS')) resultado['ASTURIAS']++;
                        else if (prov.includes('CANTABRIA')) resultado['CANTABRIA']++;
                        else if (prov.includes('LEON') || prov.includes('LE√ìN')) resultado['LEON']++;
                        else if (['LUGO', 'ORENSE', 'PONTEVEDRA', 'CORU√ëA', 'A CORU√ëA'].some(x => prov.includes(x))) resultado['GALICIA']++;
                    }
                }
            });
        } catch(e) { console.log(e); }
        return resultado;
    }

    // -----------------------------------------------------------
    // INTERVALO DE MANTENIMIENTO (Cada 400ms)
    // -----------------------------------------------------------
    setInterval(() => {
        
        // --- 1. ARREGLO MEN√ö (Solo Totales, Factura, etc.) ---
        const menuItems = ["Totales", "Factura", "Dash", "Pedidos", "Clientes", "Alertas", "Objetivos", "Mapa"];
        
        menuItems.forEach(label => {
            // Buscar por texto exacto
            const elements = Array.from(document.querySelectorAll('span, p, div')).filter(el => el.textContent.trim() === label);
            
            elements.forEach(textEl => {
                const btn = textEl.closest('a') || textEl.closest('[role="button"]') || textEl.parentElement;
                
                if (btn) {
                    // Aplicar limpieza
                    if (!btn.classList.contains('menu-btn-clean')) {
                        btn.classList.add('menu-btn-clean');
                    }

                    // Chequear activo (color de fondo azul o clase active)
                    const style = window.getComputedStyle(btn);
                    if (style.backgroundColor.includes('23') || style.backgroundColor.includes('37') || btn.className.includes('active')) {
                        if (!btn.classList.contains('menu-active-border')) btn.classList.add('menu-active-border');
                    } else {
                        btn.classList.remove('menu-active-border');
                    }

                    // CASO ESPEC√çFICO: El s√≠mbolo Euro de "Totales"
                    if (label === "Totales") {
                        // Buscar el elemento que contiene el ‚Ç¨
                        const euroEl = Array.from(btn.querySelectorAll('*')).find(x => x.textContent.includes('‚Ç¨') && x !== textEl);
                        if (euroEl && !euroEl.classList.contains('euro-icon-big')) {
                            euroEl.classList.add('euro-icon-big');
                        }
                    }
                }
            });
        });

        // --- 2. PEDIDOS EN COMUNIDADES ---
        const datos = getContadores();
        const zonas = ['ASTURIAS', 'CANTABRIA', 'LEON', 'LE√ìN', 'GALICIA'];

        document.querySelectorAll('h3, span, div, p').forEach(el => {
            const txt = el.textContent.trim().toUpperCase();
            if (zonas.includes(txt)) {
                
                // Encontrar tarjeta contenedora
                // Subimos hasta encontrar un contenedor con sombra o fondo blanco
                let card = el.parentElement;
                let found = false;
                for(let i=0; i<5; i++) {
                   if (!card) break;
                   const style = window.getComputedStyle(card);
                   // Detectar si es una tarjeta (fondo blanco o sombra)
                   if (style.backgroundColor.includes('255, 255, 255') || style.boxShadow !== 'none') {
                       found = true;
                       break;
                   }
                   card = card.parentElement;
                }

                if (found && card) {
                    const key = (txt === 'LE√ìN') ? 'LEON' : txt;
                    const cantidad = datos[key];

                    // Buscar si ya insertamos el contador
                    let contador = card.querySelector('.contador-extra-simple');
                    
                    if (!contador) {
                        contador = document.createElement('div');
                        contador.className = 'contador-extra-simple';
                        card.appendChild(contador); // Lo a√±adimos AL FINAL de la tarjeta
                    }

                    // Actualizar texto
                    const nuevoTexto = `üì¶ ${cantidad} Pedidos`;
                    if (contador.textContent !== nuevoTexto) {
                        contador.textContent = nuevoTexto;
                    }
                    
                    // Asegurar que el PRECIO est√© visible y ordenado
                    const precio = Array.from(card.querySelectorAll('div, span')).find(x => x.textContent.includes('‚Ç¨'));
                    if (precio && el.nextElementSibling !== precio) {
                         // Mover precio justo debajo del t√≠tulo si no est√° ah√≠
                         el.after(precio);
                         precio.style.display = "block";
                         precio.style.fontSize = "1.2rem";
                         precio.style.fontWeight = "bold";
                         precio.style.color = "#2563eb";
                    }
                }
            }
        });

        // --- 3. TEXTOS Y FECHAS (Standard) ---
        // Hist√≥rico -> Anual
        document.querySelectorAll('*').forEach(el => {
            if(el.children.length === 0 && el.textContent.trim().length > 0) {
                const t = el.textContent.trim().toUpperCase();
                if (t === "HIST√ìRICO" || t === "HISTORICO") {
                    el.textContent = "ANUAL";
                    el.classList.add('texto-anual-fixed');
                }
                if (t === "MEDIA MENSUAL GLOBAL") {
                     el.textContent = "VENTA MEDIA ANUAL";
                }
            }
        });

        // Fechas
        document.querySelectorAll('td, div, span, p').forEach(el => {
            const t = el.textContent.trim();
            if (/^\d{4}-\d{2}-\d{2}$/.test(t)) {
                const [y, m, d] = t.split('-');
                el.textContent = `${d}-${m}-${y}`;
                el.classList.add('fecha-destacada');
            }
        });

        // Top Clientes
        const headerTop = Array.from(document.querySelectorAll('h2, h3, div')).find(x => x.textContent.includes("Top Clientes"));
        if(headerTop) {
            const container = headerTop.closest('div').parentElement;
            if(container) {
                container.querySelectorAll('div').forEach(row => {
                   const items = row.querySelectorAll('span, div, p');
                   let p = null, n = null;
                   items.forEach(x => {
                       if(x.textContent.includes('‚Ç¨')) p = x;
                       else if(x.textContent.length > 2) n = x;
                   });
                   if(p && n) {
                       if(!p.classList.contains('importe-top-ajustado')) p.classList.add('importe-top-ajustado');
                       if(!n.classList.contains('top-client-name')) n.classList.add('top-client-name');
                   }
                });
            }
        }

    }, 400); 
  </script>
</body>
</html>
