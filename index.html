<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
  <title>Gesti√≥n de Ventas</title>
   
  <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
  <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
  <link rel="manifest" href="./manifest.webmanifest">

  <style>
    /* --- ESTILOS AUXILIARES --- */
    
    /* 1. Barras de objetivos (Solo el gr√°fico, no el texto) */
    .objetivo-barra-track-destacado {
        background-color: #e2e8f0 !important; /* Gris suave para que se vea el recorrido */
        opacity: 1 !important;
    }
    .objetivo-barra-fill-destacado {
        /* Aseguramos que el azul se vea bien */
        opacity: 1 !important;
    }

    /* 2. Contador de pedidos (Tu estilo preferido) */
    .contador-pedidos-extra {
        display: block;
        margin-top: 5px;
        padding-top: 5px;
        border-top: 1px solid #e2e8f0;
        color: #475569; 
        font-size: 0.85rem;
        font-weight: 700;
    }

    /* 3. Euro Grande en el men√∫ */
    .euro-fix-menu {
        font-size: 24px !important;
        display: inline-block;
        line-height: 1;
        margin-bottom: 2px;
    }

    /* 4. Textos fijos */
    .texto-anual {
        text-transform: uppercase !important;
        font-weight: 700 !important;
        color: #3b82f6 !important;
    }
    
    /* 5. Fechas */
    .fecha-espanol {
        font-weight: 600;
        color: #1e293b;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // ==========================================
    // 1. C√ÅLCULO DE PEDIDOS
    // ==========================================
    function contarPedidos() {
        const resultado = { 'ASTURIAS': 0, 'CANTABRIA': 0, 'LEON': 0, 'GALICIA': 0 };
        try {
            const raw = localStorage.getItem('ventas-storage');
            if (!raw) return resultado;
            
            const db = JSON.parse(raw);
            if (!db.orders) return resultado;

            const anio = localStorage.getItem('selectedYear') || new Date().getFullYear().toString();
            
            // Mapeo robusto
            const mapaClientes = {};
            if(db.clients) {
                db.clients.forEach(c => {
                    const rawName = c.name || c.nombre || c.razonSocial;
                    const rawProv = c.province || c.provincia || c.Provincia || c.region;
                    if(rawName && rawProv) {
                        mapaClientes[rawName.trim().toUpperCase()] = rawProv.trim().toUpperCase();
                    }
                });
            }

            db.orders.forEach(o => {
                if (o.date && String(o.date).startsWith(anio)) {
                    const nombreCliente = o.clientName ? o.clientName.trim().toUpperCase() : '';
                    const prov = mapaClientes[nombreCliente];
                    if (prov) {
                        if (prov.includes('ASTURIAS')) resultado['ASTURIAS']++;
                        else if (prov.includes('CANTABRIA')) resultado['CANTABRIA']++;
                        else if (prov.includes('LEON') || prov.includes('LE√ìN')) resultado['LEON']++;
                        else if (['LUGO', 'ORENSE', 'PONTEVEDRA', 'CORU√ëA', 'A CORU√ëA', 'A CORUNA'].some(x => prov.includes(x))) resultado['GALICIA']++;
                    }
                }
            });
        } catch(e) { console.error(e); }
        return resultado;
    }

    // ==========================================
    // 2. EL ARREGLADOR VISUAL
    // ==========================================
    setInterval(() => {
        
        // --- A. MEN√ö INFERIOR ---
        const etiquetasMenu = ["Totales", "Factura", "Dash", "Pedidos", "Clientes", "Alertas", "Objetivos", "Mapa"];
        etiquetasMenu.forEach(label => {
            const elementosTexto = Array.from(document.querySelectorAll('span, div, p, a')).filter(el => el.textContent.trim() === label);
            elementosTexto.forEach(textoEl => {
                const boton = textoEl.closest('a') || textoEl.closest('[role="button"]') || textoEl.parentElement;
                if (boton) {
                    boton.style.backgroundColor = 'transparent';
                    boton.style.boxShadow = 'none';
                    boton.style.border = 'none';
                    
                    const hijos = boton.querySelectorAll('*');
                    hijos.forEach(hijo => {
                        if(hijo.tagName !== 'SVG' && hijo.tagName !== 'IMG') {
                            hijo.style.color = '#ffffff';
                        }
                        if (label === "Totales" && hijo.textContent.includes('‚Ç¨')) {
                            if (!hijo.classList.contains('euro-fix-menu')) hijo.classList.add('euro-fix-menu');
                        }
                    });

                    const iconos = boton.querySelectorAll('svg, img');
                    iconos.forEach(ico => ico.style.filter = 'brightness(0) invert(1)');

                    const estiloComp = window.getComputedStyle(boton);
                    if (location.pathname.includes(label.toLowerCase()) || boton.className.includes('active') || estiloComp.backgroundColor.includes('235')) {
                        boton.style.borderBottom = '3px solid white';
                        boton.style.paddingBottom = '4px';
                    } else {
                        boton.style.borderBottom = 'none';
                    }
                }
            });
        });

        // --- B. CONTADORES DE PEDIDOS ---
        const contadores = contarPedidos();
        const zonas = ['ASTURIAS', 'CANTABRIA', 'LEON', 'LE√ìN', 'GALICIA'];

        document.querySelectorAll('h3, span, div, p').forEach(el => {
            const texto = el.textContent.trim().toUpperCase();
            if (zonas.includes(texto)) {
                let tarjeta = el.parentElement;
                let encontrada = false;
                for(let i=0; i<5; i++) {
                    if(!tarjeta) break;
                    const estilo = window.getComputedStyle(tarjeta);
                    if (estilo.backgroundColor.includes('255, 255, 255') || estilo.boxShadow !== 'none') {
                        encontrada = true;
                        break;
                    }
                    tarjeta = tarjeta.parentElement;
                }

                if (encontrada && tarjeta) {
                    const key = (texto === 'LE√ìN') ? 'LEON' : texto;
                    const numPedidos = contadores[key];

                    const precio = Array.from(tarjeta.querySelectorAll('*')).find(x => x.textContent.includes('‚Ç¨') && x !== tarjeta);
                    if (precio && el.nextElementSibling !== precio) {
                        el.after(precio);
                        precio.style.display = 'block';
                        precio.style.marginBottom = '5px';
                    }

                    let divContador = tarjeta.querySelector('.contador-pedidos-extra');
                    if (!divContador) {
                        divContador = document.createElement('div');
                        divContador.className = 'contador-pedidos-extra';
                        tarjeta.appendChild(divContador);
                    }
                    
                    const textoContador = `üì¶ ${numPedidos} Pedidos`;
                    if (divContador.textContent !== textoContador) {
                        divContador.textContent = textoContador;
                    }
                }
            }
        });

        // --- C. OBJETIVOS (Solo arreglar visualizaci√≥n de barras) ---
        // Buscamos las etiquetas pero NO las modificamos, solo las usamos para encontrar la barra
        document.querySelectorAll('span, div, p, h3, h4').forEach(el => {
            const txt = el.textContent.trim();
            if(txt.includes('Objetivo') && txt.length < 30) {
                // NO TOCAMOS EL TEXTO (el)
                
                // Buscamos la barra cercana
                let container = el.parentElement;
                if(container) {
                    // Buscamos la barra de relleno (div con width % y color de fondo)
                    const filler = Array.from(container.querySelectorAll('div')).find(div => {
                        const s = window.getComputedStyle(div);
                        return (s.backgroundColor.includes('37') || s.backgroundColor.includes('235')) && div.style.width;
                    });

                    if(filler) {
                        if(!filler.classList.contains('objetivo-barra-fill-destacado')) {
                            filler.classList.add('objetivo-barra-fill-destacado');
                        }
                        // Al padre (el track) le damos un poco de color para que se vea el hueco
                        if(filler.parentElement && !filler.parentElement.classList.contains('objetivo-barra-track-destacado')) {
                            filler.parentElement.classList.add('objetivo-barra-track-destacado');
                        }
                    }
                }
            }
        });

        // --- D. TEXTOS GENERALES ---
        document.querySelectorAll('*').forEach(el => {
            if (el.children.length === 0 && el.textContent.trim()) {
                const t = el.textContent.trim().toUpperCase();
                if (t === "HIST√ìRICO" || t === "HISTORICO") {
                    el.textContent = "ANUAL";
                    el.classList.add('texto-anual');
                }
                if (t === "MEDIA MENSUAL GLOBAL") {
                    el.textContent = "VENTA MEDIA ANUAL";
                }
            }
        });

        // --- E. FECHAS ---
        document.querySelectorAll('td, span, p').forEach(el => {
            const t = el.textContent.trim();
            if (/^\d{4}-\d{2}-\d{2}$/.test(t)) {
                const [y, m, d] = t.split('-');
                el.textContent = `${d}-${m}-${y}`;
                el.classList.add('fecha-espanol');
            }
        });

    }, 500);
  </script>
</body>
</html>
